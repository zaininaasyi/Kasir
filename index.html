<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kasir Toko Tanaman</title>
  <style>
    /* Light Mode (Default) */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif; margin: 0; padding: 10px; background-color: #f0f2f5; color: #333; transition: background-color 0.3s, color 0.3s; }
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin: 15px 0; }
    h2, h3, h4 { color: #1a1a1a; margin-top: 0; }
    input, select, button { padding: 12px 15px; margin: 8px 0; width: 100%; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
    button { background-color: #28a745; color: white; font-weight: bold; border: none; cursor: pointer; transition: background-color 0.2s; }
    button:hover { background-color: #218838; }
    button:disabled { background-color: #aaa; cursor: not-allowed; }
    .hidden { display: none; }
    #loader, #reportLoader { text-align: center; padding: 20px; }
    .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    #userInfo { flex-grow: 1; color: #555; font-size: 14px;}
    #userInfo a { font-weight:bold; color:#dc3545; text-decoration:none; font-size: 12px; }
    #theme-toggle { width: 40px; height: 40px; padding: 0; margin-left: 10px; font-size: 20px; border-radius: 50%; background-color: #e9ecef; color: #333; border: 1px solid #ddd; line-height: 1; }
    .nav { display: flex; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 12px; margin: 0 auto; padding: 5px; }
    .nav-button { flex: 1; padding: 15px; text-align: center; background: none; border: none; font-size: 16px; font-weight: bold; color: #555; cursor: pointer; border-radius: 8px; }
    .nav-button.active { background: #28a745; color: #fff; }
    .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; }
    .product-card { border: 1px solid #eee; border-radius: 8px; overflow: hidden; text-align: center; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); padding-bottom: 10px; }
    .product-card img { width: 100%; height: 100px; object-fit: cover; }
    .product-card p { margin: 8px 5px; font-size: 14px; }
    .cart-item { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
    .cart-item-details { flex-basis: 100%; display: flex; justify-content: space-between; align-items: center; }
    .cart-item-info { flex-grow: 1; margin-right: 10px; }
    .btn-small { padding: 5px 10px; font-size: 12px; width: auto; background-color: #007bff; margin-top: 5px;}
    .btn-remove { background: none; border: none; color: #dc3545; font-size: 24px; cursor: pointer; padding: 0 5px; width: auto; line-height: 1; }
    .total-section { margin-top: 15px; font-weight: bold; font-size: 1.1em; }
    .total-section div { display: flex; justify-content: space-between; padding: 5px 0; }
    .discount-applied { color: #28a745; }
    #btnTerapkanDiskon { background-color: #ffc107; color: #333; }
    #btnTerapkanDiskon.disabled { background-color: #aaa; color: #fff; }
    #btnSelesaikanTransaksi { background-color: #007bff; }
    .payment-options label { display: block; margin: 10px 0; }
    .admin-toggle { display: flex; align-items: center; justify-content: flex-end; margin-bottom: 15px; gap: 10px; }
    .admin-toggle label { font-size: 14px; color: #555; }
    .admin-toggle input { width: auto; }
    .product-admin-info { margin-top: 8px; font-size: 11px; color: #6c757d; background-color: #f8f9fa; padding: 5px; border-radius: 4px; text-align: left; margin: 5px; }
    .product-admin-info strong { color: #007bff; }
    .filter-controls { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; }
    .filter-controls select { flex-grow: 1; }
    .filter-controls button { width: auto; flex-shrink: 0; }
    .pagination-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; }
    .pagination-controls button { width: auto; padding: 8px 15px; font-size: 14px; }
    .pagination-controls span { font-weight: bold; font-size: 14px; }
    .report-card { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;}
    .report-card h4 { margin: 0 0 10px 0; color: #555; font-size: 14px; }
    .report-card p { margin: 0; font-size: 22px; font-weight: bold; color: #1a1a1a; }
    .report-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .report-grand-total { background: #e9ecef; padding: 20px; border-radius: 12px; margin-top: 20px; }
    .report-detail-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
    .report-detail-table th, .report-detail-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    .report-detail-table th { background-color: #f2f2f2; }
    details summary { font-weight: bold; cursor: pointer; padding: 10px; background-color: #f1f1f1; border-radius: 8px; margin-top: 20px; list-style: none; /* Sembunyikan panah default */ position: relative; padding-left: 30px; }
    details summary::-webkit-details-marker { display: none; /* Sembunyikan panah di Chrome/Safari */ }
    details summary::before { content: '▶'; position: absolute; left: 10px; top: 50%; transform: translateY(-50%); }
    details[open] > summary::before { content: '▼'; }
    .cart-controls { flex-basis: 100%; display: flex; align-items: center; justify-content: space-between; background-color: #f8f9fa; padding: 8px; border-radius: 8px; margin-top: 8px; }
    .quantity-controls { display: flex; align-items: center; }
    .quantity-controls button { width: 30px; height: 30px; padding: 0; font-size: 20px; line-height: 1; border-radius: 50%; }
    .quantity-controls input { width: 50px; text-align: center; margin: 0 5px; height: auto; padding: 5px; -moz-appearance: textfield; }
    .quantity-controls input::-webkit-outer-spin-button, .quantity-controls input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .price-control { display: flex; align-items: center; gap: 5px; }
    .price-control input { width: 90px; text-align: right; padding: 5px; height: auto;}
    #strukArea { display: none; }
    
    /* Dark Mode Styles */
    body.dark-mode { background-color: #1a1a1a; color: #e0e0e0; }
    body.dark-mode .card { background-color: #2c2c2c; border: 1px solid #444; }
    body.dark-mode h2, body.dark-mode h3, body.dark-mode h4 { color: #f5f5f5; }
    body.dark-mode input, body.dark-mode select { background-color: #333; border-color: #555; color: #e0e0e0; }
    body.dark-mode input::placeholder { color: #888; }
    body.dark-mode .nav { background-color: #2c2c2c; }
    body.dark-mode .nav-button { color: #aaa; }
    body.dark-mode .nav-button.active { background: #28a745; color: #fff; }
    body.dark-mode .product-card { background-color: #333; border-color: #444; }
    body.dark-mode .cart-item { border-bottom-color: #444; }
    body.dark-mode .cart-controls { background-color: #3a3a3a; }
    body.dark-mode #theme-toggle { background-color: #444; color: #e0e0e0; border-color: #555; }
    body.dark-mode .report-card, body.dark-mode .report-grand-total { background-color: #333; }
    body.dark-mode .report-card h4 { color: #aaa; }
    body.dark-mode .report-card p { color: #f5f5f5; }
    body.dark-mode details summary { background-color: #3a3a3a; }
    body.dark-mode .report-detail-table th, body.dark-mode .report-detail-table td { border-color: #555; }
    body.dark-mode .report-detail-table th { background-color: #444; }
    
    @media print {
      body * { visibility: hidden; }
      #strukArea, #strukArea * { visibility: visible; }
      #strukArea { position: absolute; left: 0; top: 0; width: 100%; max-width: 58mm; font-family: 'Courier New', Courier, monospace; line-height: 1.4; font-size: 10pt; }
      #strukArea h3 { text-align: center; margin: 0; font-size: 12pt; }
      #strukArea p { margin: 2px 0; }
      #strukArea table { width: 100%; border-collapse: collapse; margin-top: 5px; }
      #strukArea td { text-align: left; padding: 1px 0; vertical-align: top; }
      #strukArea .total-line td { border-top: 1px dashed #000; padding-top: 5px; }
      #strukArea .footer { text-align: center; margin-top: 10px; font-size: 9pt; }
    }
  </style>
</head>
<body>
  <div class="container" id="loginPage">
    <div class="card">
      <h2>Login Kasir</h2>
      <input type="email" id="emailInput" placeholder="Email (contoh: kasir@tokotanaman.com)">
      <button onclick="login()">Masuk</button>
    </div>
  </div>

  <div id="appContainer" class="hidden">
    <div class="container">
      <div class="header-controls">
        <p id="userInfo"></p>
        <button id="theme-toggle" onclick="toggleTheme()">☀️</button>
      </div>
      <div class="nav">
        <button class="nav-button active" id="navKasir" onclick="tampilkanHalaman('pos')">Kasir</button>
        <button class="nav-button" id="navLaporan" onclick="tampilkanHalaman('laporan')">Laporan</button>
      </div>
    </div>
    
    <div id="posPage">
      <div class="container">
        <div id="loader">Memuat produk...</div>
        <div id="mainContent" class="hidden">
          <div class="card">
            <h3>Pilih Produk</h3>
            <div class="admin-toggle">
              <label for="toggleInfoModal">Tampilkan Info Modal</label>
              <input type="checkbox" id="toggleInfoModal" onchange="toggleInfoModalView()">
            </div>
            <div class="filter-controls">
              <select id="categorySelect" onchange="filterByCategory(this.value)"></select>
              <button onclick="filterByCategory('Semua')">Home</button>
            </div>
            <input type="text" id="searchInput" placeholder="Cari tanaman..." onkeyup="updateProductView()">
            <div class="product-grid" id="produkList"></div>
            <div class="pagination-controls hidden" id="paginationControls">
              <button id="prevPageBtn" onclick="changePage(-1)">&laquo; Sebelumnya</button>
              <span id="pageInfo"></span>
              <button id="nextPageBtn" onclick="changePage(1)">Berikutnya &raquo;</button>
            </div>
          </div>
          <div class="card">
            <button onclick="toggleForm('memberFormContainer')" style="background-color: #6c757d;">+ Daftarkan Member Baru</button>
            <div id="memberFormContainer" class="hidden" style="margin-top: 15px;">
              <h3>Form Member Baru</h3>
              <input type="text" id="newMemberName" placeholder="Nama Member Baru">
              <input type="number" id="newMemberHp" placeholder="Nomor HP Member Baru">
              <button onclick="daftarkanMemberBaru(this)">+ Daftarkan</button>
            </div>
          </div>
          <div class="card">
            <button onclick="toggleForm('manualItemFormContainer')" style="background-color: #6c757d;">+ Tambah Item Manual</button>
            <div id="manualItemFormContainer" class="hidden" style="margin-top: 15px;">
              <h3>Form Item Manual</h3>
              <input type="text" id="manualItemName" placeholder="Nama Item (cth: Biaya Antar)">
              <input type="number" id="manualItemPrice" placeholder="Harga">
              <button onclick="tambahItemManual()">+ Tambah</button>
            </div>
          </div>
          <div class="card" id="keranjangCard">
            <h3>Keranjang Belanja</h3>
            <button onclick="toggleForm('diskonFormContainer')" style="background-color: #6c757d;">Gunakan Diskon Member</button>
            <div id="diskonFormContainer" class="hidden" style="margin-top: 15px; border-bottom: 1px solid #f0f0f0; padding-bottom: 15px;">
              <input type="text" id="memberId" placeholder="ID Member (No. HP)">
              <button id="btnTerapkanDiskon" onclick="terapkanDiskon(this)">Terapkan Diskon</button>
            </div>
            <div id="cartItems">Tidak ada item.</div>
            <div class="total-section">
              <div id="subtotalLine"><span>Subtotal:</span> <span id="subtotalHarga">Rp 0</span></div>
              <div id="diskonLine" class="hidden"><span>Penghematan Member:</span> <span id="nilaiDiskon" class="discount-applied">Rp 0</span></div>
              <hr>
              <div><span>Total:</span> <span id="totalHarga">Rp 0</span></div>
            </div>
            <button id="btnSelesaikanTransaksi" class="hidden" onclick="tampilkanPembayaran()">Lanjut ke Pembayaran</button>
          </div>
          <div class="card hidden" id="paymentCard">
            <h3>Detail Pembayaran</h3>
            <h4>Total Tagihan: <span id="paymentTotalTagihan">Rp 0</span></h4>
            <div class="payment-options">
              <label><input type="radio" name="metodePembayaran" value="Tunai" onchange="togglePaymentDetails()" checked> Tunai</label>
              <label><input type="radio" name="metodePembayaran" value="Non-Tunai" onchange="togglePaymentDetails()"> Non-Tunai</label>
            </div>
            <div id="tunaiDetails">
              <input type="number" id="uangDiterima" placeholder="Uang Diterima (Rp)" oninput="hitungKembalian()">
              <p>Kembalian: <strong id="kembalian">Rp 0</strong></p>
            </div>
            <div id="nonTunaiDetails" class="hidden">
              <select id="jenisNonTunai">
                <option value="QRIS">QRIS</option> <option value="Shopee">Shopee</option> <option value="Tokopedia">Tokopedia</option> <option value="Transfer">Transfer</option>
              </select>
            </div>
            <button id="btnKonfirmasiPembayaran" onclick="selesaikanTransaksi(this)">Konfirmasi & Simpan</button>
            <button style="background-color: #6c757d;" onclick="batalPembayaran()">Kembali ke Keranjang</button>
          </div>
          <div class="card hidden" id="postTransactionCard">
            <h4>Transaksi Berhasil!</h4>
            <p style="text-align:center; color:#555; font-size: 14px;">Kembali ke kasir...</p>
            <button id="btnCetakStruk" onclick="cetakStruk()">Cetak Struk</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="container hidden" id="laporanPage">
       <div class="card">
         <h3 id="laporanTitle">Laporan Penjualan Hari Ini</h3>
         <p><small>(Data diperbarui setiap ada transaksi baru)</small></p>
         <div id="reportLoader">Memuat laporan...</div>
         <div id="reportContent" class="hidden"></div>
         <div id="detailDropdownContainer"></div>
       </div>
    </div>
  </div>
  
  <div id="strukArea"></div>

  <script>
    var semuaProduk = [], keranjang = [], currentUser = null;
    var currentPage = 1;
    var itemsPerPage = 6;
    var isMemberActive = false;
    var lastTransactionData = {};

    function toggleTheme() {
      var body = document.body;
      body.classList.toggle('dark-mode');
      var theme = body.classList.contains('dark-mode') ? 'dark' : 'light';
      localStorage.setItem('theme', theme);
      document.getElementById('theme-toggle').textContent = theme === 'dark' ? '🌙' : '☀️';
    }

    function toggleForm(elementId) {
      document.getElementById(elementId).classList.toggle('hidden');
    }

    // PERBAIKAN FINAL: Fungsi untuk menampilkan/menyembunyikan form Nego
    function toggleNegoForm(index, show) {
        var btn = document.getElementById('nego-btn-' + index);
        var form = document.getElementById('price-control-' + index);
        if (show) {
            btn.classList.add('hidden');
            form.classList.remove('hidden');
        } else {
            btn.classList.remove('hidden');
            form.classList.add('hidden');
        }
    }

    window.onload = function() { 
      try {
        var savedUser = localStorage.getItem('currentUser'); 
        if (savedUser) { 
          setupApp(JSON.parse(savedUser)); 
        } 
      } catch (e) {
        console.error("Gagal memuat sesi:", e);
        localStorage.removeItem('currentUser');
      }
      
      var savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        document.getElementById('theme-toggle').textContent = '🌙';
      } else {
        document.getElementById('theme-toggle').textContent = '☀️';
      }
    };

    function login() {
      var email = document.getElementById('emailInput').value;
      if (!email) {
        alert('Email tidak boleh kosong.');
        return;
      }
      google.script.run.withSuccessHandler(hasilLogin).withFailureHandler(function() {
        alert('Gagal terhubung ke server.');
      }).cekLogin(email);
    }
    
    function logout() { 
      if (confirm("Apakah Anda yakin ingin logout?")) {
        localStorage.removeItem('currentUser');
        location.reload();
      } 
    }

    function setupApp(user) { 
      currentUser = user; 
      document.getElementById('userInfo').innerHTML = '<span>Kasir: ' + currentUser.email + ' | Cabang: ' + currentUser.cabang + '</span> <a href="#" onclick="logout(); return false;">Logout</a>'; 
      document.getElementById('loginPage').classList.add('hidden'); 
      document.getElementById('appContainer').classList.remove('hidden'); 
      muatProduk(); 
    }
    
    function hasilLogin(res) { 
      if (res && res.success) { 
        localStorage.setItem('currentUser', JSON.stringify(res.user)); 
        setupApp(res.user); 
      } else { 
        alert((res && res.message) || 'Login gagal. Respons tidak valid dari server.'); 
      } 
    }
    
    function muatProduk() {
      google.script.run.withSuccessHandler(tampilkanProduk).withFailureHandler(function() {
        alert('Gagal memuat produk.');
      }).getProduk();
    }

    function tampilkanProduk(data) {
      if (!data || !Array.isArray(data)) {
        alert("Gagal memuat data produk atau format data salah. Cek sheet 'Produk'.");
        document.getElementById('loader').textContent = "Error: Data Produk Tidak Valid.";
        return;
      }
      semuaProduk = data; 
      var container = document.getElementById('produkList');
      var filterSelect = document.getElementById('categorySelect');
      container.innerHTML = '';
      filterSelect.innerHTML = '';
      
      var categories = ['Semua'];
      var categorySet = new Set(data.map(function(p) { return p && p['Jenis']; }).filter(Boolean));
      categories = categories.concat(Array.from(categorySet));
      
      categories.forEach(function(category) {
        var option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        filterSelect.appendChild(option);
      });

      data.forEach(function(p, index) { 
        try {
          if (!p || !p['Nama Produk']) {
            console.warn('Data produk di baris spreadsheet ' + (index + 2) + ' tidak valid, dilewati.');
            return; 
          }
          var div = document.createElement('div'); 
          div.className = 'product-card';
          div.dataset.jenis = p['Jenis'] || ''; 
          div.dataset.index = index;
          div.style.display = 'none';
          
          var hargaJual = parseInt(p['Harga Jual']) || 0;
          var hargaMember = parseInt(p['Harga Member']) || 0;
          var hargaModal = parseInt(p['Harga Modal']) || 0;
          var supplier = p['Supplier'] || 'Tidak ada'; 

          div.innerHTML = 
            '<img src="' + (p['Foto URL'] || 'https://placehold.co/100x100/e2e8f0/e2e8f0?text=x') + '" alt="' + p['Nama Produk'] + '" onerror="this.onerror=null;this.src=\'https://placehold.co/100x100/e2e8f0/e2e8f0?text=x\';">' +
            '<p>' + p['Nama Produk'] + ' (' + (p['Ukuran/Variasi'] || '') + ')</p>' +
            '<p><strong>Rp ' + hargaJual.toLocaleString() + '</strong></p>' +
            '<div class="product-admin-info hidden">' +
            '  <small>Modal: Rp ' + hargaModal.toLocaleString() + '<br>' +
            '  <strong>Member: Rp ' + hargaMember.toLocaleString() + '</strong><br>' +
            '  Supplier: ' + supplier + '</small>' +
            '</div>' +
            '<button class="btn-small" onclick="tambahKeKeranjang(' + index + ')">+ Keranjang</button>';
          container.appendChild(div); 
        } catch (e) {
          console.error('Error saat memproses produk di baris spreadsheet ' + (index + 2) + ':', p, e);
        }
      }); 
      
      document.getElementById('loader').classList.add('hidden'); 
      document.getElementById('mainContent').classList.remove('hidden'); 
      toggleInfoModalView();
      updateProductView();
    }

    function tambahKeKeranjang(index) {
      var produk = semuaProduk[index];
      var itemAda = keranjang.find(function(item) {
        return item.produk['ID Produk'] === produk['ID Produk'] && item.produk['Ukuran/Variasi'] === produk['Ukuran/Variasi'];
      });
      var hargaJual = parseInt(produk['Harga Jual']) || 0;
      var hargaMember = parseInt(produk['Harga Member']) || 0;
      var hargaEfektif = (isMemberActive && hargaMember > 0 && hargaMember < hargaJual) ? hargaMember : hargaJual;
      if (itemAda) { 
        itemAda.qty++; 
      } else { 
        keranjang.push({ produk: produk, qty: 1, hargaSaatIni: hargaEfektif }); 
      }
      updateKeranjang();
    }
    
    function ubahJumlah(index, amount) {
      var item = keranjang[index];
      if (item) {
        item.qty += amount;
        if (item.qty <= 0) {
          hapusItem(index);
        } else {
          updateKeranjang();
        }
      }
    }

    function ubahHarga(inputElement, index) {
      var item = keranjang[index];
      if (item) {
        var newPrice = parseInt(inputElement.value);
        if (isNaN(newPrice) || newPrice < 0) {
          var hargaJual = parseInt(item.produk['Harga Jual']) || 0;
          var hargaMember = parseInt(item.produk['Harga Member']) || 0;
          item.hargaSaatIni = (isMemberActive && hargaMember > 0 && hargaMember < hargaJual) ? hargaMember : hargaJual;
        } else {
          item.hargaSaatIni = newPrice;
        }
        updateKeranjang();
      }
    }
    
    function setJumlah(inputElement, index) {
      var item = keranjang[index];
      if (item) {
        var newQuantity = parseInt(inputElement.value);
        if (isNaN(newQuantity) || newQuantity <= 0) {
          hapusItem(index);
        } else {
          item.qty = newQuantity;
          updateKeranjang();
        }
      }
    }
    
    function hapusItem(index) {
      keranjang.splice(index, 1);
      updateKeranjang();
    }

    function updateKeranjang() {
      var container = document.getElementById('cartItems');
      if (keranjang.length === 0) {
        container.innerHTML = 'Tidak ada item.';
        document.getElementById('btnSelesaikanTransaksi').classList.add('hidden');
      } else {
        container.innerHTML = '';
        keranjang.forEach(function(item, i) {
          var div = document.createElement('div');
          div.className = 'cart-item';
          var totalItem = item.qty * item.hargaSaatIni;
          // PERBAIKAN FINAL: Struktur HTML baru yang lebih ringkas dan responsif
          div.innerHTML = 
            '<div class="cart-item-details">' +
            '  <div class="cart-item-info">' +
                 item.produk['Nama Produk'] + ' (' + (item.produk['Ukuran/Variasi'] || '') + ')<br>' +
            '    <strong>' + item.qty + ' x ' + item.hargaSaatIni.toLocaleString() + ' = Rp ' + totalItem.toLocaleString() + '</strong>' +
            '  </div>' +
            '  <button class="btn-remove" onclick="hapusItem(' + i + ')">&times;</button>' +
            '</div>' +
            '<div class="cart-controls">' +
            '  <div class="quantity-controls">' +
            '    <button onclick="ubahJumlah(' + i + ', -1)">-</button>' +
            '    <input type="number" value="' + item.qty + '" onchange="setJumlah(this, ' + i + ')">' +
            '    <button onclick="ubahJumlah(' + i + ', 1)">+</button>' +
            '  </div>' +
            '  <button id="nego-btn-' + i + '" class="btn-small" style="background-color: #ffc107; color: #333;" onclick="toggleNegoForm(' + i + ', true)">Nego</button>' +
            '  <div id="price-control-' + i + '" class="price-control hidden">' +
            '    <span>Rp</span>' +
            '    <input type="number" value="' + item.hargaSaatIni + '" onchange="ubahHarga(this, ' + i + ')">' +
            '    <button class="btn-small" style="background-color: #28a745;" onclick="toggleNegoForm(' + i + ', false)">OK</button>' +
            '  </div>' +
            '</div>';
          container.appendChild(div);
        });
        document.getElementById('btnSelesaikanTransaksi').classList.remove('hidden');
      }
      kalkulasiTotal();
    }
    
    function kalkulasiTotal() {
      var subtotal = 0;
      var subtotalNormal = 0;
      keranjang.forEach(function(item) {
        var hargaJualNormal = parseInt(item.produk['Harga Jual']) || 0;
        subtotal += item.qty * item.hargaSaatIni;
        subtotalNormal += item.qty * hargaJualNormal;
      });
      document.getElementById('subtotalHarga').textContent = 'Rp ' + subtotalNormal.toLocaleString();
      document.getElementById('subtotalLine').classList.toggle('hidden', keranjang.length === 0);
      var penghematan = subtotalNormal - subtotal;
      if (penghematan > 0) {
        document.getElementById('diskonLine').classList.remove('hidden');
        document.getElementById('nilaiDiskon').textContent = '- Rp ' + penghematan.toLocaleString();
      } else {
        document.getElementById('diskonLine').classList.add('hidden');
      }
      document.getElementById('totalHarga').textContent = 'Rp ' + subtotal.toLocaleString();
      return { totalAkhir: subtotal, totalHemat: penghematan };
    }
    
    function terapkanDiskon(btn) {
      var nomorHp = document.getElementById('memberId').value;
      if (!nomorHp) {
        alert('Silakan masukkan nomor HP member.');
        return;
      }
      btn.disabled = true;
      btn.textContent = 'Mengecek...';
      google.script.run.withSuccessHandler(function(res) {
        if (res.success) {
          alert('Harga member untuk ' + res.nama + ' berhasil diterapkan.');
          isMemberActive = true;
          btn.textContent = 'Harga Member Aktif';
          btn.classList.add('disabled');
        } else {
          alert(res.message);
          isMemberActive = false;
          btn.disabled = false;
          btn.textContent = 'Terapkan Diskon';
        }
        updateKeranjang();
      }).withFailureHandler(function() {
        alert('Gagal menghubungi server untuk cek member.');
        btn.disabled = false;
        btn.textContent = 'Terapkan Diskon';
      }).cekMember(nomorHp);
    }

    function daftarkanMemberBaru(btn) {
      var nama = document.getElementById('newMemberName').value;
      var nomorHp = document.getElementById('newMemberHp').value;
      if (!nama || !nomorHp) {
        alert('Nama dan Nomor HP tidak boleh kosong.');
        return;
      }
      btn.disabled = true;
      btn.textContent = 'Mendaftarkan...';
      var dataMember = { nama: nama, nomorHp: nomorHp };
      google.script.run.withSuccessHandler(function(res) {
        alert(res.message);
        btn.disabled = false;
        btn.textContent = '+ Daftarkan';
        if (res.success) {
          document.getElementById('newMemberName').value = '';
          document.getElementById('newMemberHp').value = '';
          toggleForm('memberFormContainer'); // Tutup form setelah sukses
        }
      }).withFailureHandler(function() {
        alert('Gagal menghubungi server untuk mendaftarkan member.');
        btn.disabled = false;
        btn.textContent = '+ Daftarkan';
      }).tambahMemberBaru(dataMember);
    }

    function tambahItemManual() {
      var name = document.getElementById('manualItemName').value;
      var price = parseInt(document.getElementById('manualItemPrice').value);
      if (name && price > 0) {
        var manualProduct = {
          'ID Produk': 'MANUAL-' + Date.now(),
          'Nama Produk': name,
          'Ukuran/Variasi': 'Custom',
          'Harga Jual': price,
          'Harga Member': price,
          'Harga Modal': 0,
          'Supplier': 'Internal'
        };
        keranjang.push({ produk: manualProduct, qty: 1, hargaSaatIni: price });
        updateKeranjang();
        document.getElementById('manualItemName').value = '';
        document.getElementById('manualItemPrice').value = '';
        toggleForm('manualItemFormContainer'); // Tutup form setelah sukses
      } else {
        alert('Nama item dan harga manual harus diisi.');
      }
    }
    
    function tampilkanPembayaran() {
      if (keranjang.length === 0) {
        alert('Keranjang kosong.');
        return;
      }
      var totalInfo = kalkulasiTotal();
      document.getElementById('paymentTotalTagihan').textContent = 'Rp ' + totalInfo.totalAkhir.toLocaleString();
      document.getElementById('keranjangCard').classList.add('hidden');
      document.getElementById('paymentCard').classList.remove('hidden');
      hitungKembalian();
    }
    
    function batalPembayaran() {
      document.getElementById('paymentCard').classList.add('hidden');
      document.getElementById('keranjangCard').classList.remove('hidden');
    }
    
    function togglePaymentDetails() {
      var selectedMethod = document.querySelector('input[name="metodePembayaran"]:checked').value;
      document.getElementById('tunaiDetails').classList.toggle('hidden', selectedMethod !== 'Tunai');
      document.getElementById('nonTunaiDetails').classList.toggle('hidden', selectedMethod === 'Tunai');
    }
    
    function hitungKembalian() {
      var totalInfo = kalkulasiTotal();
      var uangDiterima = parseInt(document.getElementById('uangDiterima').value) || 0;
      var kembalian = uangDiterima - totalInfo.totalAkhir;
      document.getElementById('kembalian').textContent = 'Rp ' + (kembalian >= 0 ? kembalian.toLocaleString() : 0);
    }
    
    function selesaikanTransaksi(btn) {
      var metode = document.querySelector('input[name="metodePembayaran"]:checked').value;
      var detailMetode = (metode === 'Non-Tunai') ? document.getElementById('jenisNonTunai').value : '';
      var totalInfo = kalkulasiTotal();
      var dataTransaksi = {
        items: keranjang.map(function(item) {
          return { produk: item.produk, qty: item.qty, hargaAkhirSatuan: item.hargaSaatIni };
        }),
        memberId: document.getElementById('memberId').value,
        metodePembayaran: metode,
        detailMetode: detailMetode,
        diskonJumlah: totalInfo.totalHemat,
        totalAkhir: totalInfo.totalAkhir,
        timestamp: new Date().toISOString(),
        cabang: currentUser.cabang
      };

      lastTransactionData = dataTransaksi; // Simpan data untuk struk
      btn.disabled = true;
      btn.textContent = 'Menyimpan...';
      google.script.run.withSuccessHandler(onTransaksiSuccess).withFailureHandler(onTransaksiFailure).simpanTransaksi(dataTransaksi);
    }
    
    function onTransaksiSuccess(response) {
      var btnKonfirmasi = document.getElementById('btnKonfirmasiPembayaran');
      if (response === "Sukses") {
        document.getElementById('paymentCard').classList.add('hidden');
        document.getElementById('postTransactionCard').classList.remove('hidden');
        generateStruk(); // Generate struk in the background

        // Automatically return to the main page after 2.5 seconds
        setTimeout(function() {
            kembaliKeHalamanAwal();
        }, 2500); 

      } else {
        alert("Gagal menyimpan transaksi: " + response);
      }
      // Reset the confirmation button regardless of outcome
      btnKonfirmasi.disabled = false;
      btnKonfirmasi.textContent = 'Konfirmasi & Simpan';
    }
    
    function onTransaksiFailure(error) {
      alert("Terjadi kesalahan saat menyimpan transaksi: " + error.message);
      var btnKonfirmasi = document.getElementById('btnKonfirmasiPembayaran');
      btnKonfirmasi.disabled = false;
      btnKonfirmasi.textContent = 'Konfirmasi & Simpan';
    }
    
    function kembaliKeHalamanAwal() {
      document.getElementById('postTransactionCard').classList.add('hidden');
      document.getElementById('keranjangCard').classList.remove('hidden');
      resetKeranjang();
      filterByCategory('Semua');
    }

    function resetKeranjang() {
      keranjang = [];
      isMemberActive = false;
      lastTransactionData = {};
      document.getElementById('memberId').value = '';
      var btnDiskon = document.getElementById('btnTerapkanDiskon');
      btnDiskon.textContent = 'Terapkan Diskon';
      btnDiskon.disabled = false;
      btnDiskon.classList.remove('disabled');
      updateKeranjang();
    }
    
    function generateStruk() {
      var strukContainer = document.getElementById('strukArea');
      var totalInfo = kalkulasiTotal();
      var now = new Date();
      var date = now.toLocaleDateString('id-ID');
      var time = now.toLocaleTimeString('id-ID');

      var itemsHtml = '';
      lastTransactionData.items.forEach(function(item) {
        itemsHtml +=
          '<tr>' +
          '  <td colspan="3">' + item.produk['Nama Produk'] + '</td>' +
          '</tr>' +
          '<tr>' +
          '  <td>' + item.qty + 'x</td>' +
          '  <td style="text-align:right;">' + item.hargaAkhirSatuan.toLocaleString() + '</td>' +
          '  <td style="text-align:right;">' + (item.qty * item.hargaAkhirSatuan).toLocaleString() + '</td>' +
          '</tr>';
      });

      strukContainer.innerHTML =
        '<h3>Toko Tanaman</h3>' +
        '<p>Cabang: ' + currentUser.cabang + '</p>' +
        '<p>Kasir: ' + currentUser.email + '</p>' +
        '<p>Tanggal: ' + date + ' ' + time + '</p>' +
        '<hr>' +
        '<table>' + itemsHtml + '</table>' +
        '<hr>' +
        '<table>' +
        '  <tr class="total-line">' +
        '    <td colspan="2">Subtotal</td>' +
        '    <td style="text-align:right;">' + (totalInfo.totalAkhir + totalInfo.totalHemat).toLocaleString() + '</td>' +
        '  </tr>' +
        (totalInfo.totalHemat > 0 ?
        '  <tr>' +
        '    <td colspan="2">Diskon</td>' +
        '    <td style="text-align:right;">-' + totalInfo.totalHemat.toLocaleString() + '</td>' +
        '  </tr>' : '') +
        '  <tr class="total-line">' +
        '    <td colspan="2"><strong>TOTAL</strong></td>' +
        '    <td style="text-align:right;"><strong>' + totalInfo.totalAkhir.toLocaleString() + '</strong></td>' +
        '  </tr>' +
        '</table>' +
        '<p class="footer">Terima kasih telah berbelanja!</p>';
    }

    function cetakStruk() {
      window.print();
    }
    
    function tampilkanHalaman(halaman) {
      var posPage = document.getElementById('posPage');
      var laporanPage = document.getElementById('laporanPage');
      var navKasir = document.getElementById('navKasir');
      var navLaporan = document.getElementById('navLaporan');
      if (halaman === 'laporan') {
        posPage.classList.add('hidden');
        laporanPage.classList.remove('hidden');
        navKasir.classList.remove('active');
        navLaporan.classList.add('active');
        muatLaporan();
      } else {
        laporanPage.classList.add('hidden');
        posPage.classList.remove('hidden');
        navLaporan.classList.remove('active');
        navKasir.classList.add('active');
      }
    }
    
    function muatLaporan() {
      if (!currentUser) return;
      document.getElementById('reportLoader').classList.remove('hidden');
      document.getElementById('reportContent').classList.add('hidden');
      document.getElementById('detailDropdownContainer').innerHTML = ''; // Kosongkan container

      google.script.run.withSuccessHandler(tampilkanDataLaporan).withFailureHandler(gagalMuatLaporan).getLaporanHarian({ role: currentUser.role, cabang: currentUser.cabang });
      google.script.run.withSuccessHandler(tampilkanDetailLaporan).withFailureHandler(gagalMuatLaporan).getLaporanDetail({ role: currentUser.role, cabang: currentUser.cabang });
    }

    function gagalMuatLaporan(error) {
      var loader = document.getElementById('reportLoader');
      loader.textContent = 'Gagal memuat laporan: ' + error.toString();
    }
    
    function tampilkanDataLaporan(data) {
      if (data.error) {
        gagalMuatLaporan(data.error);
        return;
      }
      var reportContent = document.getElementById('reportContent');
      reportContent.innerHTML = '';
      var grandTotal = 0;
      var grandTransaksi = 0;
      data.reports.forEach(function(report) {
        var reportHTML = 
          '<div class="report-card">' +
          '<h4>Laporan Cabang: ' + report.cabang + '</h4>' +
          '<div class="report-grid">' +
          '  <div><h4>Total Penjualan</h4><p>Rp ' + report.totalPenjualan.toLocaleString() + '</p></div>' +
          '  <div><h4>Jumlah Transaksi</h4><p>' + report.jumlahTransaksi + '</p></div>' +
          '  <div><h4>Penjualan Tunai</h4><p>Rp ' + report.totalTunai.toLocaleString() + '</p></div>' +
          '  <div><h4>Penjualan Non-Tunai</h4><p>Rp ' + report.totalNonTunai.toLocaleString() + '</p></div>' +
          '</div></div>';
        reportContent.innerHTML += reportHTML;
        grandTotal += report.totalPenjualan;
        grandTransaksi += report.jumlahTransaksi;
      });
      if (currentUser.role === 'Admin' && data.reports.length > 1) {
        document.getElementById('laporanTitle').textContent = 'Laporan Gabungan Semua Cabang';
        var grandTotalHTML = 
          '<div class="report-grand-total">' +
          '<h3>Total Keseluruhan (Semua Cabang)</h3>' +
          '<h4>Total Pemasukan: Rp ' + grandTotal.toLocaleString() + '</h4>' +
          '<h4>Total Transaksi: ' + grandTransaksi + '</h4></div>';
        reportContent.innerHTML += grandTotalHTML;
      } else if (currentUser.role === 'Kasir' || data.reports.length === 1) {
        document.getElementById('laporanTitle').textContent = 'Laporan Penjualan Hari Ini (' + currentUser.cabang + ')';
      }
      document.getElementById('reportLoader').classList.add('hidden');
      reportContent.classList.remove('hidden');
    }
    
    function tampilkanDetailLaporan(data) {
        var mainContainer = document.getElementById('detailDropdownContainer');
        mainContainer.innerHTML = ''; // Selalu bersihkan container

        if(data.error) {
            mainContainer.innerHTML = '<p style="color:red;">Gagal memuat detail.</p>';
            return;
        }

        // Fungsi bantuan untuk membuat tabel HTML dari daftar transaksi
        function createDetailTable(transactions) {
            if (!transactions || transactions.length === 0) {
                return '<p>Tidak ada detail transaksi untuk ditampilkan.</p>';
            }
            var table = '<div style="overflow-x:auto;"><table class="report-detail-table"><thead><tr><th>Waktu</th><th>Produk</th><th>Qty</th><th>Harga Satuan</th><th>Total</th></tr></thead><tbody>';
            transactions.forEach(function(item) {
                table += '<tr>';
                table += '<td>' + item.timestamp + '</td>';
                table += '<td>' + item.produk + ' (' + (item.variasi || '') + ')</td>';
                table += '<td>' + item.qty + '</td>';
                table += '<td>' + item.hargaSatuan.toLocaleString() + '</td>';
                table += '<td>' + item.total.toLocaleString() + '</td>';
                table += '</tr>';
            });
            table += '</tbody></table></div>';
            return table;
        }

        if (currentUser.role === 'Admin' && data.groupedTransactions) {
            var cabangKeys = Object.keys(data.groupedTransactions);
            if (cabangKeys.length === 0) {
              mainContainer.innerHTML = '<p>Belum ada detail transaksi hari ini di semua cabang.</p>';
              return;
            }
            cabangKeys.forEach(function(cabangName) {
                var detailsElement = document.createElement('details');
                detailsElement.innerHTML = 
                    '<summary>Lihat Detail Item Terjual - Cabang ' + cabangName + '</summary>' +
                    createDetailTable(data.groupedTransactions[cabangName]);
                mainContainer.appendChild(detailsElement);
            });
        } 
        else if (currentUser.role !== 'Admin' && data.transactions) {
            var detailsElement = document.createElement('details');
            detailsElement.innerHTML = 
                '<summary>Lihat Detail Item Terjual Hari Ini</summary>' +
                createDetailTable(data.transactions);
            mainContainer.appendChild(detailsElement);
        } else {
             mainContainer.innerHTML = '<p>Belum ada detail transaksi hari ini.</p>';
        }
    }

    function toggleInfoModalView() {
      var isChecked = document.getElementById('toggleInfoModal').checked;
      var adminInfoElements = document.querySelectorAll('.product-admin-info');
      adminInfoElements.forEach(function(el) {
        el.classList.toggle('hidden', !isChecked);
      });
    }

    function filterByCategory(jenis) {
      document.getElementById('categorySelect').value = jenis;
      currentPage = 1;
      updateProductView();
    }
    
    function updateProductView() {
      var activeCategory = document.getElementById('categorySelect').value;
      var searchTerm = document.getElementById('searchInput').value.toLowerCase();
      var allCards = document.querySelectorAll('.product-card');
      var filteredCards = Array.from(allCards).filter(function(card) {
        var cardCategory = card.dataset.jenis;
        var cardText = card.innerText.toLowerCase();
        var isCategoryMatch = (activeCategory === 'Semua' || cardCategory === activeCategory);
        var isSearchMatch = cardText.includes(searchTerm);
        return isCategoryMatch && isSearchMatch;
      });
      allCards.forEach(function(card) {
        card.style.display = 'none';
      });
      var totalPages = Math.ceil(filteredCards.length / itemsPerPage);
      var startIndex = (currentPage - 1) * itemsPerPage;
      var endIndex = startIndex + itemsPerPage;
      var pageCards = filteredCards.slice(startIndex, endIndex);
      pageCards.forEach(function(card) {
        card.style.display = 'block';
      });
      updatePaginationControls(totalPages, filteredCards.length);
    }
    
    function updatePaginationControls(totalPages) {
      var controls = document.getElementById('paginationControls');
      var prevBtn = document.getElementById('prevPageBtn');
      var nextBtn = document.getElementById('nextPageBtn');
      var pageInfo = document.getElementById('pageInfo');
      if (totalPages > 1) {
        controls.classList.remove('hidden');
        pageInfo.textContent = 'Halaman ' + currentPage + ' dari ' + totalPages;
        prevBtn.disabled = (currentPage === 1);
        nextBtn.disabled = (currentPage === totalPages);
      } else {
        controls.classList.add('hidden');
      }
    }
    
    function changePage(direction) {
      currentPage += direction;
      updateProductView();
    }
  </script>
</body>
</html>

